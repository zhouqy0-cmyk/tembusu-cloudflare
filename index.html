<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>庭步苏大学 - 完整管理系统</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- ✅ PDF.js (v2.16.105 - 最后一个带 build/pdf.min.js 的版本) -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
    <script>
        // 设置 workerSrc —— 必须与主库同版本
        pdfjsLib.GlobalWorkerOptions.workerSrc = 
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
    </script>

    <!-- ✅ Mammoth for DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.7.2/mammoth.browser.min.js"></script>

    <!-- DOCX 解析（不受影响） -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.7.2/mammoth.browser.min.js"></script>


    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(to right, #2196F3, #9C27B0); color: white; padding: 30px 20px; text-align: center; position: relative; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .user-info-bar {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }
        .user-info-bar span {
            color: white;
            font-weight: bold;
        }
        .user-info-bar .user-badge {
            background: rgba(255,255,255,0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: normal;
        }
        .user-info-bar #userNameDisplay {
            font-weight: bold;
            font-size: 14px;
        }
        .user-info-hidden {
            display: none !important;
        }
        .user-info-bar .btn-link {
            background: white;
            color: #2196F3;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            border: none;
        }
        .user-info-bar .btn-link:hover {
            background: rgba(255,255,255,0.9);
        }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .status { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .status.success { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .status.error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .buttons { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-purple { background: #764ba2; color: white; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-orange { background: #FF9800; color: white; }
        .btn-red { background: #f44336; color: white; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h2 { margin-top: 0; color: #333; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-field { display: flex; flex-direction: column; }
        .form-field label { margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .form-field input, .form-field select, .form-field textarea { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; align-items: center; }
        .tab { padding: 12px 24px; background: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; font-size: 14px; color: #666; white-space: nowrap; }
        .tab.active { color: white; }
        .tab-blue { background: #2196F3; }
        .tab-green { background: #4CAF50; }
        .tab-purple { background: #9C27B0; }
        .tab-red { background: #f44336; }
        .tab-orange { background: #ee6916}
        .add-program-btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }
        .add-program-btn:hover {
            background: #45a049;
        }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: #1976D2; color: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-size: 14px; }
        tbody tr:hover { background: #f5f5f5; cursor: pointer; }
        .admin-select, .admin-textarea, .admin-input {
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .admin-select:focus, .admin-textarea:focus, .admin-input:focus {
            outline: none;
            border-color: #2196F3 !important;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }
        .admin-textarea {
            font-size: 13px;
            line-height: 1.4;
        }
        .admin-select {
            cursor: pointer;
            background: white;
        }
        .admin-input {
            background: #f8f9fa;
        }
        .admin-input:focus {
            background: white;
        }
        .logo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .logo-box {
            padding: 20px;
            border-radius: 8px;
            background: white;
            border: 2px solid #ddd;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: move;
            transition: all 0.3s;
        }
        .logo-box:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .logo-box.dragging {
            opacity: 0.5;
            border: 2px dashed #2196F3;
        }
        .logo-box.drag-over {
            border: 2px solid #4CAF50;
            background: #f0f8f0;
        }
        .logo-box img { max-width: 100%; max-height: 80px; object-fit: contain; margin-bottom: 10px; }
        .logo-box .logo-placeholder { font-size: 50px; color: #ddd; margin-bottom: 10px; }
        .logo-box .logo-name { font-weight: bold; margin-top: 10px; font-size: 12px; color: #333; }
        .hidden { display: none !important; }
        .user-info-bar span, .user-info-bar button { display: inline-block; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            padding: 20px; /* 为了避免内容贴边 */
        }

        .modal-content {
            background: white;
            margin: auto;
            padding: 25px;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;

            /* 必须：使弹窗本身内部可滚动 */
            max-height: 90vh;
            overflow-y: auto;

            /* 防止 flex 撑开导致无法滚动 */
            display: block;
        }

        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close:hover { color: #000; }
        .program-detail { background: #f9f9f9; padding: 15px; margin-top: 10px; border-left: 4px solid #2196F3; border-radius: 4px; }
        .program-detail h4 { margin-bottom: 10px; color: #2196F3; }
        .info-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .info-card { padding: 20px; border-radius: 8px; color: white; }
        .info-card h3 { font-size: 18px; margin-bottom: 10px; }
        .info-card.blue { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .info-card.green { background: linear-gradient(135deg, #4CAF50, #388E3C); }
        .info-card.purple { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }
        .login-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .login-tab { flex: 1; padding: 10px; border: none; background: #f0f0f0; cursor: pointer; border-radius: 8px; transition: all 0.3s; }
        .login-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .alert { padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .file-upload-area {
            border: 2px dashed #ddd;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload-area:hover {
            border-color: #2196F3;
            background: #f0f7ff;
        }
        .file-upload-area.drag-over {
            border-color: #4CAF50;
            background: #f0f8f0;
        }
        @media (max-width: 768px) {
            .info-cards, .logo-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 22px; }
            .header p { font-size: 14px; }
            .user-info-bar {
                position: static;
                justify-content: center;
                margin-top: 15px;
                flex-wrap: wrap;
            }
            .user-info-bar .btn-link {
                font-size: 12px;
                padding: 5px 12px;
            }
            .form-row { grid-template-columns: 1fr; }
            .buttons { justify-content: center; }
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            .tab { font-size: 12px; padding: 10px 16px; }
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            th, td { font-size: 12px; padding: 8px; }
            .card { padding: 15px; }
            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10% auto;
            }
            .logo-box { min-height: 100px; }
            .logo-box .logo-name { font-size: 11px; }
            .info-card h3 { font-size: 16px; }
            .info-card p { font-size: 14px; }
            .container { padding: 0 10px; }
            .admin-textarea { min-height: 40px !important; font-size: 12px; }
            .admin-input, .admin-select { font-size: 12px; padding: 4px !important; }
        }

        /* 详情弹窗外层 */
        .detail-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            align-items: center;
            justify-content: center;
        }

        /* 弹窗主体 */
        .detail-modal-content {
            background: #fff;
            width: 90%;
            max-width: 650px;
            max-height: 150vh;       /* 最大高度为视口 90%，超出可滚动 */
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            position: relative;
            overflow-y: auto;       /* 内容超出整体弹窗时滚动 */
            animation: fadeIn 0.25s ease-out;
        }


        /* 关闭按钮 */
        .detail-close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }
        .detail-close:hover {
            color: #333;
        }

        /* 标题 */
        .detail-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        /* 表单布局：两列 */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* 一个 textarea 独占一行 */
        .detail-full {
            grid-column: span 2;
        }

        /* 标签 */
        .detail-label {
            font-weight: bold;
            margin-bottom: 6px;
            color: #555;
        }

        /* textarea 样式 */
        .detail-textarea {
            width: 100%;
            min-height: 200px;      /* 设置最小高度，内容多会撑开 */
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
            background: #fafafa;
            overflow: visible;      /* 去掉内部滚动条 */
        }
        .detail-textarea:focus {
            background: #fff;
            border-color: #2196F3;
            outline: none;
            box-shadow: 0 0 4px rgba(33,150,243,0.3);
        }
        .detail-textarea.auto-height {
            height: auto;
        }

        /* 保存按钮 */
        .detail-save-btn {
            margin-top: 25px;
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        .detail-save-btn:hover {
            background: #43a047;
        }

        /* 弹出动画 */
        @keyframes fadeIn {
            from { transform: translateY(-15px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        #companyCard {
            display: none !important;
        }

    </style>
</head>
<body>
    <div class="header">
        <div class="user-info-bar" id="userInfoBar">
            <span id="userNameDisplay" class="user-info-hidden"></span>
            <span id="userRoleDisplay" class="user-badge user-info-hidden"></span>
            <button class="btn-link" onclick="showLoginModal()" id="loginBtn">登录</button>
            <button class="btn-link" onclick="showRegisterModal()" id="registerBtn">注册</button>
            <button class="btn-link user-info-hidden" onclick="logout()" id="logoutBtn">退出</button>
        </div>
        <h1>庭步苏大学 (TEMBUSU INSTITUTE)</h1>
        <p>教学项目管理系统</p>
    </div>

    <div class="container">
        <div id="statusBox" class="status success">
            <strong>已成功连接到Firebase云端</strong>
            <p>数据将自动保存并实时同步</p>
        </div>

        <div class="buttons">
            <button class="btn btn-green" onclick="checkLoginAndShowForm()">学生信息提交</button>
            <button class="btn btn-purple" onclick="showFileUpload()" id="getBtn">文件上传信息</button>
            <button class="btn btn-blue hidden" id="exportButton" onclick="exportToCSV()">导出Excel表格</button>
            <button class="btn btn-orange" onclick="checkLoginAndToggleAdmin()">管理员模式</button>
        </div>

        <div class="card hidden" id="studentForm">
            <h2>学生信息提交表</h2>

            <div class="form-row">
                <div class="form-field">
                    <label>姓名 *</label>
                    <input type="text" id="inputName">
                </div>
                <div class="form-field">
                    <label>出生日期 *</label>
                    <input type="date" id="inputBirthday">
                </div>
            </div>
            <div class="form-row">
                <div class="form-field">
                    <label>邮箱 *</label>
                    <input type="email" id="inputEmail">
                </div>
                <div class="form-field">
                    <label>联系电话 *</label>
                    <input type="tel" id="inputPhone">
                </div>
            </div>
            <div class="form-row">
                <div class="form-field">
                    <label>当前学历 *</label>
                    <select id="inputEducation">
                        <option value="">请选择</option>
                        <option value="初中">初中</option>
                        <option value="高中">高中</option>
                        <option value="本科">本科</option>
                        <option value="硕士">硕士</option>
                    </select>
                </div>
                <div class="form-field">
                    <label>感兴趣的项目</label>
                    <select id="inputProgram">
                        <option value="">请选择</option>
                        <option value="预科阶段">预科阶段</option>
                        <option value="Diploma阶段">Diploma阶段</option>
                        <option value="本科阶段">本科阶段</option>
                        <option value="研究生阶段">研究生阶段</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-field">
                    <label>推荐人姓名</label>
                    <input type="text" id="inputReferrer">
                </div>
                <div class="form-field">
                    <label>推荐人电话</label>
                    <input type="tel" id="inputReferrerPhone">
                </div>
            </div>
            <div class="form-row">
                <div class="form-field" style="grid-column: span 2;">
                    <label>家庭背景</label>
                    <textarea id="inputFamily" rows="3" placeholder="请简要描述您的家庭背景"></textarea>
                </div>
            </div>
            <div class="form-row">
                <div class="form-field" style="grid-column: span 2;">
                    <label>学习成绩描述</label>
                    <textarea id="inputAcademic" rows="3" placeholder="请描述您的学习成绩情况"></textarea>
                </div>
            </div>
            <button class="btn btn-blue" onclick="submitForm()">提交信息到云端</button>
            <button class="btn btn-orange" onclick="hideForm()" style="margin-left: 10px;">取消</button>
        </div>

        <div class="card hidden" id="adminPanel">
            <h2>管理员控制面板</h2>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <strong>云端同步状态</strong>
                <p>当前有 <span id="studentCount">0</span> 位学生信息（实时同步）</p>
            </div>
            <h3>学生列表</h3>
            <div id="studentListArea"></div>
        </div>

        <!-- 文件上传信息卡片（默认隐藏） -->
        <div class="card hidden" id="fileUploadCard">
            <h2>文件上传信息</h2>

            <div class="form-row">
                <div class="form-field" style="grid-column: span 2;">
                    <label>上传简历（PDF/Doc）</label>
                    <input type="file" id="resumeFile" accept=".pdf,.doc,.docx">
                </div>
            </div>

            <button class="btn btn-blue" onclick="uploadResume()">上传并分析简历</button>
            <button class="btn btn-orange" onclick="hideFileUpload()" style="margin-left: 10px;">取消</button>
        </div>


        <div class="tabs">
            <button class="tab active tab-blue" onclick="changeTab(0)">预科阶段</button>
            <button class="tab" onclick="changeTab(1)">Diploma阶段</button>
            <button class="tab" onclick="changeTab(2)">本科阶段</button>
            <button class="tab" onclick="changeTab(3)">研究生阶段</button>
            <button class="tab" onclick="changeTab(4)">博士阶段</button>
            <button class="add-program-btn hidden" id="addProgramBtn" onclick="showAddProgramModal()">添加项目</button>
        </div>

        <div class="card">
            <h2 id="contentTitle">预科阶段课程</h2>
            <p id="contentDesc">为升读大学做好准备的预科课程</p>
            <div id="tableArea"></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>全球合作院校</h2>
                <button class="btn btn-green btn-small hidden" id="addPartnerBtn" onclick="showAddPartnerModal()">添加院校</button>
            </div>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;" id="dragHintPartner" class="hidden">提示：拖动Logo可调整显示顺序</p>
            <div class="logo-grid" id="partnerLogos"></div>
        </div>

        <div class="card" id="companyCard">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>实践教学合作企业</h2>
                <button class="btn btn-green btn-small hidden" id="addCompanyBtn" onclick="showAddCompanyModal()">添加企业</button>
            </div>
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;" id="dragHintCompany" class="hidden">提示：拖动Logo可调整显示顺序</p>
            <div class="logo-grid" id="companyLogos"></div>
        </div>
        </div>


        <div class="info-cards">
            <div class="info-card blue">
                <h3>国际认证</h3>
                <p>新加坡教育部EduTrust四星认证，全球认可</p>
            </div>
            <div class="info-card green">
                <h3>全球合作</h3>
                <p>与10+所知名高校建立合作，提供多元升学路径</p>
            </div>
            <div class="info-card purple">
                <h3>实践教学</h3>
                <p>项目式学习，双导师制度，全球实习网络</p>
            </div>
        </div>
    </div>

    <div id="programModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeProgramModal()">&times;</span>
            <h2 id="modalTitle">项目详情</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeLoginModal()">&times;</span>
            <h2 style="text-align: center; color: #667eea; margin-bottom: 20px;">庭步苏大学</h2>

            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('login')">登录</button>
                <button class="login-tab" onclick="switchLoginTab('register')">注册</button>
            </div>

            <div id="loginAlertBox"></div>

            <div id="loginFormModal">
                <div class="form-field" style="margin-bottom: 15px;">
                    <label>邮箱</label>
                    <input type="email" id="loginEmail" placeholder="请输入邮箱">
                </div>
                <div class="form-field" style="margin-bottom: 15px;">
                    <label>密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码">
                </div>
                <button class="btn btn-blue" style="width: 100%;" onclick="login()">登录</button>
            </div>

            <div id="registerFormModal" class="hidden">
                <div class="form-field" style="margin-bottom: 15px;">
                    <label>用户类型</label>
                    <select id="userType" onchange="toggleAdminKey()">
                        <option value="student">普通用户（学生）</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                <div class="form-field" style="margin-bottom: 15px;">
                    <label>姓名</label>
                    <input type="text" id="registerName" placeholder="请输入姓名">
                </div>
                <div class="form-field" style="margin-bottom: 15px;">
                    <label>邮箱</label>
                    <input type="email" id="registerEmail" placeholder="请输入邮箱">
                </div>
                <div class="form-field" style="margin-bottom: 15px;">
                    <label>密码</label>
                    <input type="password" id="registerPassword" placeholder="至少6位">
                </div>
                <div class="form-field hidden" id="adminKeyGroup" style="margin-bottom: 15px;">
                    <label>管理员密钥</label>
                    <input type="text" id="adminKey" >
                    <!-- <small style="color: #999;">默认密钥: tembusu2024admin</small> -->
                </div>
                <button class="btn btn-green" style="width: 100%;" onclick="register()">注册</button>
            </div>
        </div>
    </div>

    <div id="editProgramModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditProgramModal()">&times;</span>
            <h2 id="editProgramTitle">添加项目</h2>
            <div class="form-field" style="margin-bottom: 15px;">
                <label>项目名称 *</label>
                <input type="text" id="editProgramName" placeholder="如：IGCSE预科课程">
            </div>
            <div class="form-field" style="margin-bottom: 15px;">
                <label>课程时长 *</label>
                <input type="text" id="editProgramDuration" placeholder="如：12个月">
            </div>
            <div class="form-field" style="margin-bottom: 15px;">
                <label>学费 *</label>
                <input type="text" id="editProgramFee" placeholder="如：SGD 18,000">
            </div>
            <div class="form-field" style="margin-bottom: 15px;">
                <label>其他信息</label>
                <input type="text" id="editProgramExtra" placeholder="如：开班时间/模块/合作院校">
            </div>
            <div class="form-field" style="margin-bottom: 15px;">
                <label>招生数量 *</label>
                <input type="text" id="editProgramQuota" placeholder="如：20人">
            </div>
            <div class="form-field" style="margin-bottom: 15px;">
                <label>项目详情 *</label>
                <textarea id="editProgramDetail" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="请输入项目特色和详细介绍"></textarea>
            </div>
            <input type="hidden" id="editProgramIndex" value="">
            <button class="btn btn-blue" style="width: 100%;" onclick="saveProgramEdit()">保存</button>
        </div>
    </div>

    <div id="editLogoModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditLogoModal()">&times;</span>
            <h2 id="editLogoTitle">添加合作院校</h2>
            <div class="form-field" style="margin-bottom: 15px;">
                <label>院校名称 *</label>
                <input type="text" id="editLogoName" placeholder="如：Kingston University">
            </div>

            <div class="form-field" style="margin-bottom: 15px;">
                <label>上传Logo图片</label>
                <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoFileSelect(event)">
                <div class="file-upload-area" onclick="document.getElementById('logoFileInput').click()" id="fileUploadArea">
                    <p style="margin: 10px 0; color: #666;">点击或拖拽图片到此处上传</p>
                    <p style="font-size: 12px; color: #999;">支持 JPG, PNG, SVG 等格式</p>
                </div>
            </div>

            <div class="form-field" style="margin-bottom: 15px;">
                <label>或输入图片URL</label>
                <input type="url" id="editLogoUrl" placeholder="https://example.com/logo.png">
            </div>

            <div class="form-field" style="margin-bottom: 15px;">
                <label>Logo预览</label>
                <div style="border: 2px dashed #ddd; padding: 20px; border-radius: 8px; min-height: 100px; display: flex; align-items: center; justify-content: center; background: #f9f9f9;">
                    <img id="logoPreview" src="" alt="Logo预览" style="max-width: 100%; max-height: 80px; object-fit: contain; display: none;">
                    <span id="logoPreviewPlaceholder" style="color: #999;">上传或输入URL后会显示预览</span>
                </div>
            </div>
            <input type="hidden" id="editLogoType" value="">
            <input type="hidden" id="editLogoIndex" value="">
            <button class="btn btn-blue" style="width: 100%;" onclick="saveLogoEdit()">保存</button>
        </div>
    </div>

    <!-- ====== 合作院校/企业 信息弹窗 ====== -->
    <div id="partnerDetailModal" class="detail-modal">
        <div class="detail-modal-content">

            <span class="detail-close" onclick="closePartnerDetail()">×</span>

            <h3 id="detailTitle" class="detail-title">合作院校详情</h3>

            <div class="detail-grid">
                <div class="detail-full">
                    <div class="detail-label">简介（500字以内）</div>
                    <textarea id="detailIntro" class="detail-textarea"></textarea>
                </div>

                <div>
                    <div class="detail-label">合作专业</div>
                    <textarea id="detailMajor" class="detail-textarea" style="min-height:80px;"></textarea>
                </div>

                <div>
                    <div class="detail-label">学生要求</div>
                    <textarea id="detailRequirement" class="detail-textarea" style="min-height:80px;"></textarea>
                </div>
            </div>

            <button id="detailSaveBtn" class="detail-save-btn" onclick="savePartnerDetail()">
                保存修改
            </button>

        </div>
    </div>

    <!-- 学生详情弹窗 -->
    <div id="studentDetailModal" class="modal">
    <div class="modal-content" style="max-width: 750px;">

        <span class="detail-close" onclick="closeStudentDetail()">×</span>
        <h3 id="studentDetailTitle" class="detail-title">学生详情</h3>

        <div class="detail-grid">

            <!-- 基本信息 -->
            <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">基本信息</h4>
            </div>

            <div>
                <div class="detail-label">姓名</div>
                <input id="stu_name" class="detail-input">
            </div>

            <div>
                <div class="detail-label">生日</div>
                <input id="stu_birthday" class="detail-input">
            </div>

            <div>
                <div class="detail-label">邮箱</div>
                <input id="stu_email" class="detail-input">
            </div>

            <div>
                <div class="detail-label">电话</div>
                <input id="stu_phone" class="detail-input">
            </div>

            <div>
                <div class="detail-label">学历</div>
                <input id="stu_education" class="detail-input">
            </div>

            <div>
                <div class="detail-label">项目类型</div>
                <input id="stu_program" class="detail-input">
            </div>

            <div>
            <div class="detail-label">专业</div>
                <input id="stu_major" class="detail-input">
            </div>

            <div>
                <div class="detail-label">毕业院校</div>
                <input id="stu_university" class="detail-input">
            </div>


            <!-- 中介、费用 -->
            <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">推荐人与费用</h4>
            </div>

            <div>
                <div class="detail-label">推荐人</div>
                <input id="stu_agent" class="detail-input">
            </div>

            <div>
                <div class="detail-label">推荐费</div>
                <input id="stu_fee_agent" class="detail-input">
            </div>

            <div>
                <div class="detail-label">总费用</div>
                <input id="stu_fee_total" class="detail-input">
            </div>

            <!-- 学生情况 -->
            <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">学生情况</h4>
            </div>

            <div class="detail-full">
                <div class="detail-label">学生目标</div>
                <textarea id="stu_goal" class="detail-textarea"></textarea>
            </div>

            <div>
                <div class="detail-label">能否自己申请</div>
                <select id="stu_can_apply" class="detail-input">
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>
            </div>

            <div>
                <div class="detail-label">付费能力</div>
                <select id="stu_afford" class="detail-input">
                    <option value="high">高</option>
                    <option value="medium">中</option>
                    <option value="low">低</option>
                </select>
            </div>

            <div class="detail-full">
                <div class="detail-label">推荐的项目</div>
                <textarea id="stu_recommend_program" class="detail-textarea"></textarea>
            </div>

            <!-- 英语与文书 -->
            <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">申请准备情况</h4>
            </div>

            <div>
                <label><input type="checkbox" id="stu_ps_ready"> 文书已完成</label>
            </div>

            <div>
                <label><input type="checkbox" id="stu_english_ok"> 英语成绩达标</label>
            </div>

            <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">技能 / 奖项 / 活动</h4>
            </div>

            <div class="detail-full">
                <div class="detail-label">技能（Skills）</div>
                <textarea id="stu_skills" class="detail-textarea"></textarea>
            </div>

            <div class="detail-full">
                <div class="detail-label">获奖经历（Awards）</div>
                <textarea id="stu_awards" class="detail-textarea"></textarea>
            </div>

            <div class="detail-full">
                <div class="detail-label">课外活动（Activities）</div>
                <textarea id="stu_activities" class="detail-textarea"></textarea>
            </div>


            <div>
                <div class="detail-label">对接人</div>
                <input id="stu_handler" class="detail-input">
            </div>

            <div>
                <div class="detail-label">目前是否签约</div>
                <select id="stu_signed" class="detail-input">
                    <option value="yes">是</option>
                    <option value="no">否</option>
                </select>
            </div>

            <!-- 实习和项目 -->
             <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">实习 / 工作经历</h4>
            </div>

            <div class="detail-full">
                <div id="stu_experience_area"></div>
            </div>

            <div class="detail-full">
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: #2196F3;">项目经历</h4>
            </div>

            <div class="detail-full">
                <div id="stu_projects_area"></div>
            </div>

            <!-- 上传 -->
            <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">材料上传</h4>
            </div>

            <div>
                <div class="detail-label">Personal Statement</div>
                <input type="file" id="stu_ps_file">
            </div>

            <div>
                <div class="detail-label">简历</div>
                <input type="file" id="stu_cv_file">
            </div>

            <!-- 多选学校 -->
            <div class="detail-full">
                <h4 style="margin-bottom: 10px; color: #2196F3;">对接学校（多选）</h4>
                <div id="stu_school_list"></div>
            </div>

        </div>

        <button class="detail-save-btn" onclick="saveStudentDetail()">保存修改</button>

    </div>

    </div>

    <!-- 删除确认弹窗 -->
    <div id="deleteConfirmModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width: 350px; text-align:center;">
        <p style="margin-bottom: 20px;">确定要删除该学生吗？</p>

        <button id="confirmDeleteBtn" style="background:#d9534f; color:white; padding:8px 20px; border:none; border-radius:5px;">确定</button>
        <button onclick="closeDeleteModal()" style="margin-left:10px; padding:8px 20px;">取消</button>
    </div>
    </div>



    <script>

        initAuthState()
        /***************************************************
        * Cloudflare Worker 代理版（前端）
        * 不再使用 firebase.initializeApp(...)
        * 所有 Firebase 访问全部经由 Worker 转发
        ***************************************************/

        // Cloudflare Worker 基础地址
        const WORKER_BASE = "https://tembusu.zhouqingyu27.workers.dev";  // ← 换成你自己的 Worker URL

        // 保留你的逻辑变量（不用动）
        const ADMIN_KEY = "tembusu2024admin";
        var app, auth, isConnected = true;
        var currentUser = null;
        var adminMode = false;
        var draggedElement = null;
        var draggedIndex = null;
        var draggedType = null;

        /***************************************************
        * 用 Worker 代理 Firebase Database（全新 database 对象）
        ***************************************************/
        const database = {
            get: async function (path) {
                const url = `${WORKER_BASE}/firebase?path=${encodeURIComponent(path)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error("Database GET failed");
                return res.json();
            },

            set: async function (path, data) {
                const url = `${WORKER_BASE}/firebase`;
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        path: path,   // 必须有 path
                        value: data   // 数据对象
                    })
                });
                if (!res.ok) throw new Error("Database SET failed");
                return res.json();
            }
        };


        // ==========================
        // Cloudflare Worker 基础 URL
        // ==========================
        const CF_BASE = "https://tembusu.zhouqingyu27.workers.dev";


        // ==========================
        // 伪 Worker（Fake Worker）
        // ==========================
        const worker = {
            onmessage: null,

            async postMessage(message) {
                const { type, data } = message;

                try {

                    // =========================================
                    // 注册 register
                    // =========================================
                    if (type === "register") {
                        const userId = safeUUID(); // 前端生成 UID
                        const newUser = {
                            name: data.name,
                            email: data.email,
                            password: data.password,   // 你之前逻辑存明文，这里保持一致
                            role: data.role,
                            createdAt: new Date().toISOString()
                        };

                        // 写入数据库 /users/${uid}
                        await fetch(`${CF_BASE}/firebase`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                path: `users/${userId}`,
                                value: newUser
                            })
                        });

                        this.onmessage?.({
                            data: {
                                type: "registerSuccess",
                                userId
                            }
                        });

                        return;
                    }


                    // =========================================
                    // 登录 login
                    // =========================================
                    if (type === "login") {

                        // 读取所有用户
                        const res = await fetch(`${CF_BASE}/firebase?path=users`);
                        const users = await res.json();

                        if (!users) {
                            this.onmessage?.({
                                data: { type: "loginError", error: "没有用户数据" }
                            });
                            return;
                        }

                        let found = null;
                        for (const uid in users) {
                            const u = users[uid];
                            if (u.email === data.email && u.password === data.password) {
                                found = { uid, ...u };
                                break;
                            }
                        }

                        if (!found) {
                            this.onmessage?.({
                                data: { type: "loginError", error: "邮箱或密码错误" }
                            });
                            return;
                        }

                        // 保存登录状态到 localStorage
                        localStorage.setItem("currentUser", JSON.stringify(found));

                        this.onmessage?.({
                            data: {
                                type: "loginSuccess",
                                user: found
                            }
                        });

                        return;
                    }


                    // =========================================
                    // 登出 logout
                    // =========================================
                    if (type === "logout") {

                        localStorage.removeItem("currentUser");

                        this.onmessage?.({
                            data: {
                                type: "logoutSuccess"
                            }
                        });

                        return;
                    }


                    // 未知类型
                    console.warn("Unknown Fake Worker message type:", type);

                } catch (err) {
                    console.error("Fake Worker Error:", err);

                    this.onmessage?.({
                        data: {
                            type: `${type}Error`,
                            error: err.toString()
                        }
                    });
                }
            }
        };


        function showLoginModal() {
            document.getElementById("loginModal").style.display = "flex";
        }

        function closeLoginModal() {
            document.getElementById("loginModal").style.display = "none";
        }


        /***************************************************
        * 加载合作院校数据（替换原来的 database.ref...once）
        ***************************************************/
        function loadPartnerLogos() {
            database.get("partnerLogos")
                .then(data => {
                    if (data) {
                        partnerLogos = Object.values(data);
                    } else {
                        partnerLogos = [];
                    }
                    renderLogos();
                    console.log('✅ 已从数据库加载合作院校数据');
                })
                .catch(error => {
                    console.error('❌ 加载合作院校失败:', error);
                });
        }

        // 页面加载时执行
        window.addEventListener('load', loadPartnerLogos);

        //项目数据（课程）是静态前端数据，需要改为动态

        var programData = [
    // -------------------------------
    // 1. 预科阶段课程（Foundation / Diploma）
    // -------------------------------
    [
        {
            name: '服装设计与产品开发预科',
            duration: '4.5个月',
            fee: 'SGD 28,500（含税）',
            intake: '全年滚动',
            quota: '20人（最低开课人数）',
            detail: '进入服装设计、产品开发方向的基础课程，包含版型、缝纫、数字绘图、立裁等核心技能。'
        },
        {
            name: '商务管理预科（Diploma in Business Management）',
            duration: '420小时（约4-6个月）',
            fee: 'SGD 21,800（含税）',
            intake: '全年滚动',
            quota: '25人',
            detail: '包含9大模块，涵盖商业基础、财务会计、数字商务、AI在管理中的应用等。'
        },
        {
            name: '庭步苏国际中学 A-Level 高中课程',
            duration: 'AS（高二）+ A2（高三）2年',
            fee: 'AS: SGD 35,800；A2: SGD 35,800',
            intake: '每年 1 月、7 月',
            quota: '25人',
            detail: '1+2 模式：国内高中一年 + 新加坡庭步苏国际中学 A-Level，两年直升新/港/英名校。'
        },
        {
            name: 'A-Level 高三预科（商科方向）',
            duration: '1年',
            fee: 'SGD 21,800',
            intake: '每年 1 月/7 月',
            quota: '25人',
            detail: '商科A-Level预科，进入商科国际大一（萨里大学、格拉斯哥大学）专用。'
        },
        {
            name: 'A-Level 高三预科（艺术方向）',
            duration: '1年',
            fee: 'SGD 28,500',
            intake: '每年 1 月/7 月',
            quota: '20人',
            detail: '艺术类本科方向的预科课程，包含素描、设计基础、作品集辅导。'
        }
    ],

    // -------------------------------
    // 2. Diploma 阶段课程（Diploma / Advanced Diploma）
    // -------------------------------
    [
        {
            name: '服装设计与产品开发文凭（Diploma in Apparel Design and Product Development）',
            duration: '10-12个月',
            fee: 'SGD 19,500（庭步苏高中/预科生）/ SGD 42,900（国际学生）',
            modules: '约20+模块',
            quota: '20人',
            detail: '包含版型、缝纫、立裁、纺织、数字绘图、质量管理、虚拟样品制作等。'
        },
        {
            name: '时尚技术国际大一（Advanced Diploma in Fashion Technology）',
            duration: '12个月',
            fee: 'SGD 42,900',
            modules: '25个模块',
            quota: '25人',
            detail: '直升 Kingston 的 Fashion Promotion & Communication 或 UAL LCF 时尚设计与开发。'
        },
        {
            name: '商务管理国际大一（Advanced Diploma in Business Management）',
            duration: '420小时（约4-6个月）',
            fee: 'SGD 21,800',
            modules: '7大核心模块',
            quota: '30人',
            detail: '包含战略领导、变革管理、商法、AI驱动创新等高级商业课程。'
        }
    ],

    // -------------------------------
    // 3. 本科阶段课程（BA / Top-up / 直升）
    // -------------------------------
    [
        {
            name: '时尚推广与传播本科（BA Hons Fashion Promotion & Communication）',
            duration: '2年（直升二年级）',
            fee: '第二年 SGD 40,500；第三年 SGD 42,000',
            partner: '英国 Kingston University London',
            quota: '25人',
            detail: '专注时尚品牌营销、视觉传播、内容制作、时尚媒体与品牌战略。'
        },
        {
            name: '时尚设计与开发本科（BA Hons Fashion Design & Development）',
            duration: '2年（直升二年级）',
            fee: '每年 31,500 英镑（以UAL最新费用为准）',
            partner: '伦敦艺术大学 LCF',
            quota: '20人',
            detail: '全球排名领先的时尚设计本科，可选行业实习 DIPS/企业孵化/创意计算证书。'
        },
        {
            name: '萨里大学（University of Surrey）商科本科路径',
            duration: '2-3年',
            fee: '大二 SGD 42,900；大三 SGD 42,900（英国本校 23,700 英镑）',
            partner: 'University of Surrey',
            quota: '30人',
            detail: '通过庭步苏预科/国际大一，升读英国萨里大学商科本科。'
        },
        {
            name: '格拉斯哥大学商科本科路径（University of Glasgow）',
            duration: '3-4年',
            fee: '大二 SGD 42,900；大三大四 GBP 26,580',
            partner: 'University of Glasgow',
            quota: '30人',
            detail: '全球排名高，适合商科方向学生，通过国际大一直升本校大二/大三。'
        }
    ],

        // -------------------------------
    // 4. 研究生阶段课程（Masters）
    // -------------------------------
    [
        {
            name: '港城创新创业硕士项目',
            duration: '12-18个月',
            fee: 'HK$ 180,000-260,000',
            partner: 'City University of Hong Kong',
            quota: '20人',
            detail: '香港城市大学创新创业方向，聚焦创新技术、科技创业、商业模式设计和大湾区创新生态。'
        },
        {
            name: 'SUTD Human-Centred Design 硕士',
            duration: '12个月',
            fee: 'SGD 50,000-60,000',
            partner: 'Singapore University of Technology and Design',
            quota: '30人',
            detail: 'SUTD与MIT合作体系，结合工程、设计、用户体验、人机交互与科技创新。'
        },
        {
            name: '中文知识产权战略硕士',
            duration: '12-18个月',
            fee: 'SGD 35,000-45,000',
            partner: 'Singapore University of Social Sciences (SUSS)',
            quota: '20人',
            detail: '中文授课，重点培养国际知识产权战略、企业专利体系、技术转移与跨境商业保护能力。'
        },
        {
            name: '创新创业硕士（Warwick）',
            duration: '12-18个月',
            fee: '£32,000-40,000',
            partner: 'University of Warwick',
            quota: '15人',
            detail: '由工程学院与商学院联合授课，培养具备创业、战略、创新管理能力的高端人才。'
        }
    ],

    // -------------------------------
    // 5. 博士阶段课程（PhD / Doctor）
    // -------------------------------
    [
        {
            name: '教育学博士（USC）',
            duration: '3-5年',
            fee: 'US$ 60,000-90,000',
            partner: 'University of Southern California (USC)',
            quota: '10人',
            detail: '专注教育创新、教育政策、教育科技与学习科学，培养高级教育研究者和管理者。'
        },
        {
            name: '整体教育学博士（Maharishi）',
            duration: '3-4年',
            fee: 'US$ 35,000-45,000',
            partner: 'Maharishi International University',
            quota: '10人',
            detail: '围绕意识、心理、人类发展与整体教育体系，是国际教育中具有特色的方向。'
        },
        {
            name: '工程博士（CityU）',
            duration: '3-4年',
            fee: 'HK$ 200,000-260,000',
            partner: 'City University of Hong Kong',
            quota: '15人',
            detail: '面向工程技术、人工智能、计算机、机器人、材料工程等领域的科研与成果转化博士。'
        }
    ]

];


        var currentTab = 0;
        var tabTitles = ['预科阶段课程', 'Diploma阶段课程', '本科阶段课程', '研究生阶段课程', '博士阶段课程'];
        var tabDescriptions = ['为升读大学做好准备', '国际认可的文凭课程', '与全球名校联合培养', '专业的研究生课程', '培养高水平科研能力与创新研究'];

        var partnerLogos = [

        ];

        var companyLogos = [

        ];

        // 合作院校详情（按 partnerLogos 顺序存储）
        var partnerDetails = [];

        // 合作企业详情（按 companyLogos 顺序存储）
        var companyDetails = [];

        const schoolNames = [
            "香港城市大学 CityU",
            "新加坡科技设计大学 SUTD",
            "新加坡社会科学大学 SUSS",
            "英国华威大学 University of Warwick",
            "南加州大学 USC",
            "Maharishi International University",
            "香港城市大学（工程博士） CityU",
            "Kingston University London",
            "伦敦艺术大学 UAL",
            "萨里大学 University of Surrey",
            "格拉斯哥大学 University of Glasgow",
            "欧洲设计学院 IED",
            "柏丽慕达时装学院 Polimoda",
            "曼彻斯特城市大学 Manchester Metropolitan University",
            "巴黎国际时尚艺术学院 MOD'ART",
            "法国国际时装学院 IFA",
            "巴黎艺术学院 Paris College of Art",
            "旧金山艺术大学 Academy of Art University",
            "纽约利姆学院 LIM College",
            "大阪文化服装学院 Osaka Institute of Fashion",
            "悉尼企业家学院 Academy of Entrepreneurs",
            "昆士兰科技大学 QUT"
        ];


        /***************************************************
         *  不再使用 Firebase Auth 的登录状态监听
         *  改成使用 localStorage 维护登录状态
         *  每次页面加载时自动读取 currentUser
         ***************************************************/
        async function initAuthState() {
            console.log("=== 初始化登录状态 ===");

            // 1. 本地读取 currentUser
            const savedUser = localStorage.getItem("currentUser");

            if (!savedUser) {
                console.log("本地未找到已登录用户");
                currentUser = null;
                adminMode = false;
                updateUserUI();  // 更新界面为未登录状态
                return;
            }

            // 2. 解析本地用户
            const localUser = JSON.parse(savedUser);
            console.log("本地登录用户:", localUser);

            try {
                console.log("正在从数据库读取用户数据...");
                let userData = await database.get(`users/${localUser.uid}`);
                console.log("数据库查询完成:", userData);

                // 3. 如果数据库没有该用户 → 自动创建
                if (!userData) {
                    console.log("数据库中没有用户记录，创建新用户");

                    userData = {
                        name: localUser.name || localUser.email.split("@")[0],
                        email: localUser.email,
                        role: localUser.role || "student", // 保留本地 role
                        createdAt: new Date().toISOString()
                    };

                    await database.set(`users/${localUser.uid}`, userData);
                }

                // 4. 设置 currentUser
                currentUser = { uid: localUser.uid, ...userData };

                // 5. 设置 adminMode
                adminMode = (currentUser.role === "admin");

                console.log("用户已登录:", currentUser, "管理员模式:", adminMode);

                // 6. 更新界面
                updateUserUI();               // 更新用户相关信息
                updateInterfaceForRole();     // 显示/隐藏管理员内容

            } catch (error) {
                console.error("读取数据库用户数据失败:", error);

                // 即使数据库失败，也保留本地基本用户信息
                currentUser = {
                    uid: localUser.uid,
                    email: localUser.email,
                    name: localUser.name || localUser.email.split("@")[0],
                    role: localUser.role || "student"
                };

                adminMode = (currentUser.role === "admin");
                updateUserUI();
                updateInterfaceForRole();
            }
        }

        async function loadProgramData() {
            try {
                const dbData = await database.get('programs');
                if (dbData) {
                    // 数据库有数据 → 使用数据库数据
                    programData = [];
                    for (let i = 0; i < 5; i++) {
                        programData[i] = [];
                        if (dbData[i]) {
                            for (const key in dbData[i]) {
                                programData[i].push({ id: key, ...dbData[i][key] });
                            }
                        }
                    }
                } else {
                    // 数据库没有数据 → 使用前端死数据并写入数据库
                    await saveAllProgramsToDB();
                }
            } catch (err) {
                console.error("加载数据库项目失败，使用前端死数据", err);
                await saveAllProgramsToDB();
            }
            renderTable();
        }

        // 保存所有前端死数据到数据库
        async function saveAllProgramsToDB() {
            for (let i = 0; i < programData.length; i++) {
                const stageData = {};
                programData[i].forEach(prog => {
                    const id = prog.id || safeUUID();
                    prog.id = id; // 保存 UUID
                    stageData[id] = { ...prog };
                    delete stageData[id].id; // 数据库中不保存 id
                });
                await database.set(`programs/${i}`, stageData);
            }
        }




        function updateUserUI() {
            console.log('=== 更新UI ===');
            console.log('currentUser:', currentUser);

            const userNameEl = document.getElementById('userNameDisplay');
            const userRoleEl = document.getElementById('userRoleDisplay');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (currentUser) {
                // —— 增强容错：保证 name 和 role 始终存在 ——
                const userName = currentUser.name || (currentUser.email ? currentUser.email.split("@")[0] : "用户");
                const userRole = currentUser.role || "student";
                const roleName = userRole === "admin" ? "管理员" : "普通用户";

                console.log("用户名:", userName);
                console.log("角色:", roleName);

                // 赋值 UI
                userNameEl.textContent = userName;
                userNameEl.classList.remove('user-info-hidden');

                userRoleEl.textContent = roleName;
                userRoleEl.classList.remove('user-info-hidden');

                loginBtn.classList.add('user-info-hidden');
                registerBtn.classList.add('user-info-hidden');
                logoutBtn.classList.remove('user-info-hidden');

                // —— 管理员权限控制 ——
                if (userRole === "admin") {
                    document.getElementById('addProgramBtn').classList.remove('hidden');
                    document.getElementById('addPartnerBtn').classList.remove('hidden');
                    document.getElementById('addCompanyBtn').classList.remove('hidden');
                    document.getElementById('dragHintPartner').classList.remove('hidden');
                    document.getElementById('dragHintCompany').classList.remove('hidden');

                    console.log('管理员权限已激活');
                } else {
                    document.getElementById('addProgramBtn').classList.add('hidden');
                    document.getElementById('addPartnerBtn').classList.add('hidden');
                    document.getElementById('addCompanyBtn').classList.add('hidden');
                    document.getElementById('dragHintPartner').classList.add('hidden');
                    document.getElementById('dragHintCompany').classList.add('hidden');
                }

                console.log('UI更新完成:', userName, roleName);

                // 刷新表格内容
                renderTable();

            } else {
                console.log("用户未登录");

                userNameEl.classList.add('user-info-hidden');
                userRoleEl.classList.add('user-info-hidden');

                loginBtn.classList.remove('user-info-hidden');
                registerBtn.classList.remove('user-info-hidden');
                logoutBtn.classList.add('user-info-hidden');

                document.getElementById('addProgramBtn').classList.add('hidden');
                document.getElementById('addPartnerBtn').classList.add('hidden');
                document.getElementById('addCompanyBtn').classList.add('hidden');
                document.getElementById('dragHintPartner').classList.add('hidden');
                document.getElementById('dragHintCompany').classList.add('hidden');

                // —— 删除 adminMode 的遗留逻辑（不再需要）——
                // if (adminMode) toggleAdmin();

                renderTable();
            }

            // 刷新 logo 区域
            renderLogos();
        }


        function showLoginModal() {  //显示登录窗口
            switchLoginTab('login');
            document.getElementById('loginModal').style.display = 'flex';
        }

        function showRegisterModal() {  //显示注册窗口
            switchLoginTab('register');
            document.getElementById('loginModal').style.display = 'flex';
        }

        function closeLoginModal() {   //关闭窗口
            document.getElementById('loginModal').style.display = 'none';
        }

        function checkLoginAndShowForm() {   //检查是否登录才能打开表单
            if (!currentUser) {
                showLoginModal();
                return;
            }
            showForm();
        }

        function checkLoginAndToggleAdmin() {   //检查是否管理员才能进入 adminMode
            if (!currentUser) {
                showLoginModal();
                return;
            }
            if (currentUser.role !== 'admin') {
                alert('您没有管理员权限');
                return;
            }
            toggleAdmin();
        }

        function switchLoginTab(mode) {   //切换登录/注册 tab
            const tabs = document.querySelectorAll('.login-tab');
            tabs.forEach(t => t.classList.remove('active'));

            if (mode === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginFormModal').classList.remove('hidden');
                document.getElementById('registerFormModal').classList.add('hidden');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('loginFormModal').classList.add('hidden');
                document.getElementById('registerFormModal').classList.remove('hidden');
            }
        }

        function toggleAdminKey() {   //控制管理员密钥输入框是否显示
            const isAdmin = document.getElementById('userType').value === 'admin';
            document.getElementById('adminKeyGroup').classList.toggle('hidden', !isAdmin);
        }


        worker.onmessage = function(event) {
            const msg = event.data;

            switch (msg.type) {
                case "registerSuccess":
                    showLoginAlert("注册成功", "success");
                    setTimeout(closeLoginModal, 1200);
                    break;

                case "registerError":
                    showLoginAlert("注册失败: " + msg.error, "error");
                    break;

                case "loginSuccess":
                    showLoginAlert("登录成功", "success");
                    setTimeout(closeLoginModal, 1000);

                    // 保存用户信息
                    currentUser = msg.user;
                    localStorage.setItem("currentUser", JSON.stringify(currentUser));

                    // 设置管理员标志
                    adminMode = (currentUser.role === "admin");

                    // 调用一个函数刷新界面元素显示
                    initAuthState();  // 
                    break;


                case "loginError":
                    showLoginAlert("登录失败: " + msg.error, "error");
                    break;

                case "logoutSuccess":
                    alert("已退出登录");
                    break;
            }
        };

        function safeUUID() {
            if (crypto && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // fallback
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }


        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const userType = document.getElementById('userType').value;
            const adminKey = document.getElementById('adminKey').value;

            if (!name || !email || !password) {
                showLoginAlert('请填写所有字段', 'error');
                return;
            }

            if (userType === 'admin' && adminKey !== ADMIN_KEY) {
                showLoginAlert('管理员密钥错误', 'error');
                return;
            }

            // 直接把 register 请求发给 worker
            worker.postMessage({
                type: "register",
                data: {
                    name,
                    email,
                    password,
                    role: userType
                }
            });
        }


        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showLoginAlert('请填写所有字段', 'error');
                return;
            }

            // 发送登录请求给 worker
            worker.postMessage({
                type: "login",
                data: { email, password }
            });
        }


        function logout() {
            if (!confirm('确定要退出登录吗？')) return;

            // 退出登录请求发给 worker
            worker.postMessage({
                type: "logout"
            });
        }


        function showLoginAlert(message, type) {  //登录/注册消息显示
            const alertBox = document.getElementById('loginAlertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }

        function changeTab(index) {   //切换课程标签页
            currentTab = index;
            var tabs = document.getElementsByClassName('tab');
            var colors = ['tab-blue', 'tab-green', 'tab-purple', 'tab-red', 'tab-orange'];
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].className = 'tab';
            }
            tabs[index].className = 'tab active ' + colors[index];
            document.getElementById('contentTitle').textContent = tabTitles[index];
            document.getElementById('contentDesc').textContent = tabDescriptions[index];
            renderTable();
        }

        // Logo拖拽排序功能
        function makeDraggable(element, index, type) {
            if (!currentUser || currentUser.role !== 'admin') return;

            element.setAttribute('draggable', 'true');

            element.addEventListener('dragstart', function (e) {
                draggedElement = element;
                draggedIndex = index;
                draggedType = type;
                element.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            element.addEventListener('dragend', function () {
                element.classList.remove('dragging');
            });

            element.addEventListener('dragover', function (e) {
                e.preventDefault();
                if (draggedElement && draggedElement !== element && draggedType === type) {
                    element.classList.add('drag-over');
                }
            });

            element.addEventListener('dragleave', function () {
                element.classList.remove('drag-over');
            });

            element.addEventListener('drop', async function (e) {
                e.preventDefault();
                element.classList.remove('drag-over');

                if (draggedElement && draggedElement !== element && draggedType === type) {
                    const targetIndex = parseInt(element.getAttribute('data-index'));
                    const logos = type === 'partner' ? partnerLogos : companyLogos;

                    const temp = logos[draggedIndex];
                    logos[draggedIndex] = logos[targetIndex];
                    logos[targetIndex] = temp;

                    renderLogos();
                    showToast('排序已更新');

                    try {
                        if (type === 'partner') {
                            await database.set("partnerLogos", partnerLogos);
                        } else if (type === 'company') {
                            await database.set("companyLogos", companyLogos);
                        }
                    } catch (err) {
                        console.error("Logo 排序更新失败:", err);
                        showToast("保存失败：连接服务器异常", "error");
                    }
                }
            });
        }


        async function renderLogos() {
            const isAdmin = currentUser && currentUser.role === 'admin';

            /** ========= 渲染合作院校 Logo ========= **/
            let partnerHtml = '';
            for (let i = 0; i < partnerLogos.length; i++) {
                partnerHtml += `
                    <div class="logo-box" data-index="${i}" onclick="openPartnerDetail('partner', ${i})">
                `;

                if (isAdmin) {
                    partnerHtml += `
                        <span onclick="event.stopPropagation(); deleteLogo('partner', ${i})"
                            style="position:absolute; top:5px; right:5px; cursor:pointer; color:red; font-size:20px; z-index:10;">
                            &times;
                        </span>
                    `;
                }

                if (partnerLogos[i].url) {
                    partnerHtml += `
                        <img src="${partnerLogos[i].url}" alt="${partnerLogos[i].name}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="logo-placeholder" style="display:none;">🏛️</div>
                    `;
                } else {
                    partnerHtml += `<div class="logo-placeholder">🏛️</div>`;
                }

                partnerHtml += `<div class="logo-name">${partnerLogos[i].name}</div></div>`;
            }

            document.getElementById('partnerLogos').innerHTML = partnerHtml;


            /** ========= 渲染企业 Logo ========= **/
            let companyHtml = '';
            for (let i = 0; i < companyLogos.length; i++) {
                companyHtml += `
                    <div class="logo-box" data-index="${i}" onclick="openPartnerDetail('company', ${i})">
                `;

                if (isAdmin) {
                    companyHtml += `
                        <span onclick="event.stopPropagation(); deleteLogo('company', ${i})"
                            style="position:absolute; top:5px; right:5px; cursor:pointer; color:red; font-size:20px; z-index:10;">
                            &times;
                        </span>
                    `;
                }

                if (companyLogos[i].url) {
                    companyHtml += `
                        <img src="${companyLogos[i].url}" alt="${companyLogos[i].name}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="logo-placeholder" style="display:none;">🏢</div>
                    `;
                } else {
                    companyHtml += `<div class="logo-placeholder">🏢</div>`;
                }

                companyHtml += `<div class="logo-name">${companyLogos[i].name}</div></div>`;
            }

            document.getElementById('companyLogos').innerHTML = companyHtml;


            /** ========= 管理员拖拽排序 ========= **/
            if (isAdmin) {
                const partnerBoxes = document.querySelectorAll('#partnerLogos .logo-box');
                partnerBoxes.forEach((box, index) => makeDraggable(box, index, 'partner'));

                const companyBoxes = document.querySelectorAll('#companyLogos .logo-box');
                companyBoxes.forEach((box, index) => makeDraggable(box, index, 'company'));
            }
        }


        // 公共：更新 logo 预览
        function updateLogoPreview(base64OrUrl) {
            const input = document.getElementById('editLogoUrl');
            const preview = document.getElementById('logoPreview');
            const placeholder = document.getElementById('logoPreviewPlaceholder');

            if (input) input.value = base64OrUrl;

            if (preview) {
                preview.src = base64OrUrl;
                preview.style.display = 'block';
            }

            if (placeholder) {
                placeholder.style.display = 'none';
                placeholder.style.color = '#999';
            }
        }



        // =============================
        // 本地文件上传功能（替换版）
        // =============================
        function handleLogoFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                updateLogoPreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }



        // =============================
        // 拖拽上传功能（替换版）
        // =============================
        document.addEventListener('DOMContentLoaded', function () {
            const uploadArea = document.getElementById('fileUploadArea');
            const urlInput = document.getElementById('editLogoUrl');

            if (uploadArea) {
                uploadArea.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', function () {
                    this.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', function (e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');

                    const file = e.dataTransfer.files[0];
                    if (!file || !file.type.startsWith('image/')) {
                        alert('请拖入图片文件');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        updateLogoPreview(e.target.result);
                    };
                    reader.readAsDataURL(file);
                });
            }



            // =============================
            // URL 输入实时预览（保留你的原功能）
            // =============================
            if (urlInput) {
                urlInput.addEventListener('input', function () {
                    const url = this.value.trim();
                    const preview = document.getElementById('logoPreview');
                    const placeholder = document.getElementById('logoPreviewPlaceholder');

                    if (url) {
                        updateLogoPreview(url);

                        // 加载失败提示
                        preview.onerror = function () {
                            preview.style.display = 'none';
                            placeholder.textContent = '图片加载失败，请检查URL是否正确';
                            placeholder.style.display = 'block';
                            placeholder.style.color = '#f44336';
                        };

                        preview.onload = function () {
                            placeholder.style.display = 'none';
                        };
                    } else {
                        preview.style.display = 'none';
                        placeholder.textContent = '上传或输入URL后会显示预览';
                        placeholder.style.display = 'block';
                        placeholder.style.color = '#999';
                    }
                });
            }
        });

        // ================================
        // 统一：清空编辑表单
        // ================================
        function resetProgramForm() {
            document.getElementById('editProgramName').value = '';
            document.getElementById('editProgramDuration').value = '';
            document.getElementById('editProgramFee').value = '';
            document.getElementById('editProgramExtra').value = '';
            document.getElementById('editProgramQuota').value = '';
            document.getElementById('editProgramDetail').value = '';
            document.getElementById('editProgramIndex').value = '';
        }



        // ================================
        // 添加项目
        // ================================
        function showAddProgramModal() {
            resetProgramForm();
            document.getElementById('editProgramTitle').textContent = '添加项目';
            document.getElementById('editProgramModal').style.display = 'flex';
        }



        // ================================
        // 编辑项目
        // ================================
        function editProgram(index) {
            const program = programData[currentTab][index];

            document.getElementById('editProgramTitle').textContent = '编辑项目';
            document.getElementById('editProgramName').value = program.name || '';
            document.getElementById('editProgramDuration').value = program.duration || '';
            document.getElementById('editProgramFee').value = program.fee || '';
            document.getElementById('editProgramQuota').value = program.quota || '';
            document.getElementById('editProgramDetail').value = program.detail || '';
            document.getElementById('editProgramIndex').value = index;

            // 根据 currentTab 选择 extra 字段
            let extraValue = '';
            if (currentTab === 0) extraValue = program.intake || '';
            if (currentTab === 1) extraValue = program.modules || '';
            if (currentTab === 2) extraValue = program.partner || '';
            if (currentTab === 3) extraValue = program.institution || '';

            document.getElementById('editProgramExtra').value = extraValue;

            document.getElementById('editProgramModal').style.display = 'flex';
        }



        // ================================
        // 保存项目（新增或更新）
        // ================================
        async function saveProgramEdit() {
            const name = document.getElementById('editProgramName').value.trim();
            const duration = document.getElementById('editProgramDuration').value.trim();
            const fee = document.getElementById('editProgramFee').value.trim();
            const extra = document.getElementById('editProgramExtra').value.trim();
            const quota = document.getElementById('editProgramQuota').value.trim();
            const detail = document.getElementById('editProgramDetail').value.trim();
            const index = document.getElementById('editProgramIndex').value;

            if (!name || !duration || !fee || !quota || !detail) {
                alert('请填写所有必填项');
                return;
            }

            const newProgram = { name, duration, fee, quota, detail };

            if (currentTab === 0) newProgram.intake = extra;
            if (currentTab === 1) newProgram.modules = extra;
            if (currentTab === 2) newProgram.partner = extra;
            if (currentTab === 3) newProgram.institution = extra;

            let id;
            if (index === '') {
                // 新增
                id = safeUUID();
                newProgram.id = id;
                programData[currentTab].push(newProgram);
            } else {
                // 更新
                id = programData[currentTab][index].id;
                newProgram.id = id;
                programData[currentTab][index] = newProgram;
            }

            // 写入数据库
            const stageData = {};
            programData[currentTab].forEach(prog => {
                const pid = prog.id;
                stageData[pid] = { ...prog };
                delete stageData[pid].id;
            });
            await database.set(`programs/${currentTab}`, stageData);

            renderTable();
            closeEditProgramModal();
            showToast('项目已保存');
        }

        async function deleteProgram(index) {
            if (!confirm('确定要删除这个项目吗？')) return;

            programData[currentTab].splice(index, 1);

            // 更新数据库
            const stageData = {};
            programData[currentTab].forEach(prog => {
                const pid = prog.id;
                stageData[pid] = { ...prog };
                delete stageData[pid].id;
            });
            await database.set(`programs/${currentTab}`, stageData);

            renderTable();
            showToast('项目已删除');
        }


        function closeEditProgramModal() {
            document.getElementById('editProgramModal').style.display = 'none';
        }

        function resetLogoForm(type, titleText) {
            document.getElementById('editLogoTitle').textContent = titleText;
            document.getElementById('editLogoName').value = '';
            document.getElementById('editLogoUrl').value = '';
            document.getElementById('editLogoType').value = type;
            document.getElementById('editLogoIndex').value = '';

            const preview = document.getElementById('logoPreview');
            const placeholder = document.getElementById('logoPreviewPlaceholder');

            preview.style.display = 'none';
            preview.src = '';

            placeholder.style.display = 'block';
            placeholder.textContent = '上传或输入URL后会显示预览';
            placeholder.style.color = '#999';

            document.getElementById('editLogoModal').style.display = 'flex';
        }



        function showAddPartnerModal() {
            resetLogoForm('partner', '添加合作院校');
        }

        function showAddCompanyModal() {
            resetLogoForm('company', '添加合作企业');
        }

        function saveLogoEdit() {
            const name = document.getElementById('editLogoName').value.trim();
            const url = document.getElementById('editLogoUrl').value.trim();
            const type = document.getElementById('editLogoType').value;
            const index = document.getElementById('editLogoIndex').value;

            if (!name) {
                alert('请输入机构名称');
                return;
            }
            if (!url) {
                alert('请上传图片或输入图片URL');
                return;
            }

            const newLogo = { name, url };
            let targetArray = (type === 'partner') ? partnerLogos : companyLogos;
            let dbPath = (type === 'partner') ? 'partnerLogos' : 'companyLogos';

            // 添加 / 更新
            if (index === '') {
                targetArray.push(newLogo);
            } else {
                targetArray[index] = newLogo;
            }

            // UI 更新
            renderLogos();
            closeEditLogoModal();
            showToast('Logo已保存');

            // 同步到 Firebase
            database.ref(dbPath)
                .set(targetArray)
                .then(() => {
                    console.log(`✅ ${type} 数据已同步到 Firebase`);
                    showToast('云端已更新');
                })
                .catch(error => {
                    console.error('❌ Firebase 同步失败:', error);
                    alert('保存成功，但云端更新失败: ' + error.message);
                });
        }


        function deleteLogo(type, index) {
            if (!confirm('确定要删除这个 Logo 吗？')) return;

            let targetArray = (type === 'partner') ? partnerLogos : companyLogos;
            let dbPath = (type === 'partner') ? 'partnerLogos' : 'companyLogos';

            targetArray.splice(index, 1);

            renderLogos();
            showToast('Logo 已删除');

            database.ref(dbPath)
                .set(targetArray)
                .catch(err => console.error('Firebase 更新失败:', err));
        }


        function closeEditLogoModal() {
            document.getElementById('editLogoModal').style.display = 'none';
        }

        function renderTable() {
            const data = programData[currentTab] || [];

            // 如果没有数据
            if (data.length === 0) {
                document.getElementById('tableArea').innerHTML =
                    '<p style="text-align:center;color:#888;margin-top:20px;">暂无项目数据</p>';
                return;
            }

            const keys = Object.keys(data[0]);

            const headers = {
                name: '项目名称',
                duration: '课程时长',
                fee: '学费',
                intake: '开班时间',
                modules: '核心模块',
                partner: '合作院校',
                institution: '合作机构',
                quota: '招生数量'
            };

            let html = '<table><thead><tr>';

            keys.forEach(k => {
                if (k !== 'detail') {
                    html += `<th>${headers[k] || k}</th>`;
                }
            });

            if (currentUser && currentUser.role === 'admin') {
                html += '<th style="width: 140px;">操作</th>';
            }

            html += '</tr></thead><tbody>';

            data.forEach((row, i) => {

                // 整行点击（管理员 + 普通用户都正常打开详情）
                html += `<tr onclick="showDetail(${currentTab},${i})">`;

                keys.forEach(k => {
                    if (k !== 'detail') {
                        html += `<td>${row[k] ?? ''}</td>`;
                    }
                });

                // 管理员操作按钮
                if (currentUser && currentUser.role === 'admin') {
                    html += `
                        <td onclick="event.stopPropagation();">
                            <button class="btn btn-blue btn-small"
                                style="margin-right:5px"
                                onclick="editProgram(${i}); event.stopPropagation();">
                                编辑
                            </button>
                            <button class="btn btn-red btn-small"
                                onclick="deleteProgram(${i}); event.stopPropagation();">
                                删除
                            </button>
                        </td>
                    `;
                }

                html += '</tr>';
            });

            html += '</tbody></table>';

            document.getElementById('tableArea').innerHTML = html;
        }


        function showDetail(tab, index) {
            const p = programData[tab][index];
            if (!p) return;

            document.getElementById('modalTitle').textContent = p.name || '项目详情';

            let html = `
                <div class="program-detail">

                    <h4>课程信息</h4>
                    <p><strong>学制：</strong>${p.duration || '—'}</p>
                    <p><strong>学费：</strong>${p.fee || '—'}</p>
                    <p><strong>招生数量：</strong>${p.quota || '—'}</p>

                    <br>

                    <h4>项目特色</h4>
                    <p>${p.detail || '暂无详情'}</p>

                </div>
            `;

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('programModal').style.display = 'flex';
        }


        /* -----------------------------
        关闭项目详情弹窗
        ----------------------------- */
        function closeProgramModal() {
            document.getElementById('programModal').style.display = 'none';
        }

        /* -----------------------------
        显示报名表单
        ----------------------------- */
        function showForm() {
            document.getElementById('studentForm').classList.remove('hidden');

            if (currentUser) {
                document.getElementById('inputEmail').value = currentUser.email || "";
                document.getElementById('inputName').value = currentUser.name || "";
            }
        }

        /* -----------------------------
        隐藏报名表单
        ----------------------------- */
        function hideForm() {
            document.getElementById('studentForm').classList.add('hidden');
        }

        /* -----------------------------
        通过 Cloudflare Worker 提交表单
        ----------------------------- */
        async function submitForm() {
            var name = document.getElementById('inputName').value;
            var birthday = document.getElementById('inputBirthday').value;
            var email = document.getElementById('inputEmail').value;
            var phone = document.getElementById('inputPhone').value;
            var edu = document.getElementById('inputEducation').value;

            if (!name || !birthday || !email || !phone || !edu) {
                alert('请填写所有必填项');
                return;
            }

            // 生成唯一 studentId
            const studentId = currentUser?.uid || ("guest_" + Date.now());

            var data = {
                userId: studentId,
                name,
                birthday,
                email,
                phone,
                education: edu,
                program: document.getElementById('inputProgram').value || "",
                referrer: document.getElementById('inputReferrer').value || "",
                referrerPhone: document.getElementById('inputReferrerPhone').value || "",
                family: document.getElementById('inputFamily').value || "",
                academic: document.getElementById('inputAcademic').value || "",
                submitTime: new Date().toISOString(),
                status: "pending",
                evaluation: "",
                recommendSchool: ""
            };

            try {
                // 🔥 写入 Firebase（通过 Cloudflare Worker）
                await database.set(`/students/${studentId}`, data);

                alert("信息已成功保存到云端！");

                // 清空表单
                document.getElementById('inputName').value = '';
                document.getElementById('inputBirthday').value = '';
                document.getElementById('inputEmail').value = '';
                document.getElementById('inputPhone').value = '';
                document.getElementById('inputEducation').value = '';
                document.getElementById('inputProgram').value = '';
                document.getElementById('inputReferrer').value = '';
                document.getElementById('inputReferrerPhone').value = '';
                document.getElementById('inputFamily').value = '';
                document.getElementById('inputAcademic').value = '';

                hideForm();

            } catch (err) {
                console.error("❌ 保存失败:", err);
                alert("保存失败: " + err.message);
            }
        }

        /* -----------------------------
        管理员模式切换
        ----------------------------- */
        function toggleAdmin() {
            adminMode = !adminMode;
            var panel = document.getElementById('adminPanel');

            if (adminMode) {
                panel.classList.remove('hidden');
                loadStudents();   // ← 记得把 loadStudents 也迁移到 Worker 模式
            } else {
                panel.classList.add('hidden');
                document.getElementById('exportButton').classList.add('hidden');
            }
        }

        /***************************************************
         * Cloudflare Worker 版：loadStudents（完全替换）
         ***************************************************/
        async function loadStudents() {

            try {
                // 读取全部 students
                var allData = await database.get("students");
                if (!allData) allData = {};

                var students = Object.keys(allData).map(id => {
                    return { id, ...allData[id] };
                });

                // 显示统计数
                document.getElementById('studentCount').textContent = students.length;

                if (students.length === 0) {
                    document.getElementById('studentListArea').innerHTML = '<p>暂无数据</p>';
                    return;
                }

                // ⭐ 生成表格
                var html = `
                <div style="overflow-x:auto;">
                <table style="min-width:100%;">
                    <thead>
                        <tr>
                            <th style="min-width:80px;">姓名</th>
                            <th style="min-width:100px;">生日</th>
                            <th style="min-width:150px;">邮箱</th>
                            <th style="min-width:120px;">电话</th>
                            <th style="min-width:80px;">学历</th>
                            <th style="min-width:100px;">项目</th>
                            <th style="min-width:150px;">提交时间</th>
                            <th style="min-width:100px;">状态</th>
                            <th style="min-width:200px;">评价</th>
                            <th style="min-width:150px;">推荐学校</th>
                            <th style="min-width:150px;">最近联系时间</th>
                            <th style="min-width:80px;">删除</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                for (var s of students) {
                    var time = new Date(s.submitTime).toLocaleString('zh-CN');

                    // 点击整行查看详情
                    html += `<tr onclick="openStudentDetail('${s.id}')" style="cursor:pointer;">`;

                    html += `<td>${s.name}</td>`;
                    html += `<td>${s.birthday}</td>`;
                    html += `<td>${s.email}</td>`;
                    html += `<td>${s.phone}</td>`;
                    html += `<td>${s.education}</td>`;
                    html += `<td>${s.program || '-'}</td>`;
                    html += `<td>${time}</td>`;

                    // 状态（自动保存）
                    html += `
                        <td onclick="event.stopPropagation()">
                            <select class="admin-select"
                                onchange="updateStatus('${s.id}', this.value)"
                                style="width:100%;padding:5px;border:1px solid #ddd;border-radius:4px;">
                                <option value="pending" ${s.status === 'pending' ? 'selected' : ''}>未对接</option>
                                <option value="connected" ${s.status === 'connected' ? 'selected' : ''}>已对接</option>
                            </select>
                        </td>`;

                    // 评价（自动保存）
                    html += `
                        <td onclick="event.stopPropagation()">
                            <textarea class="admin-textarea"
                                style="width:100%;min-height:60px;padding:5px;border:1px solid #ddd;border-radius:4px;"
                                onblur="updateEval('${s.id}', this.value)">${s.evaluation || ''}</textarea>
                        </td>`;

                    // 推荐学校
                    html += `
                        <td onclick="event.stopPropagation()">
                            <input type="text"
                                class="admin-input"
                                value="${s.recommendSchool || ''}"
                                onblur="updateSchool('${s.id}', this.value)"
                                style="width:100%;padding:5px;border:1px solid #ddd;border-radius:4px;">
                        </td>`;

                    // 最近联系时间
                    html += `
                        <td onclick="event.stopPropagation()">
                            <input type="text"
                                class="admin-input"
                                placeholder="YYYY/MM/DD"
                                value="${s.lastContact || ''}"
                                onblur="updateLastContact('${s.id}', this.value)"
                                style="width:100%;padding:5px;border:1px solid #ddd;border-radius:4px;">
                        </td>`;

                    // 删除按钮
                    html += `<td onclick="event.stopPropagation()">
                                <button onclick="deleteStudent('${s.id}')"
                                        style="padding:4px 8px;color:#fff;background:#d9534f;border:none;border-radius:4px;">
                                    删除
                                </button>
                            </td>`;

                    html += `</tr>`;
                }

                html += `
                    </tbody>
                </table>
                </div>
                `;

                // 编辑提示
                html += `
                    <div style="background:#fff3cd;padding:15px;border-radius:5px;margin-top:15px;border:1px solid #ffc107;">
                        <strong>编辑提示：</strong>
                        <ul style="margin:10px 0 0 20px;">
                            <li>选择“状态”会自动保存</li>
                            <li>“评价”输入后点击框外自动保存</li>
                            <li>“推荐学校”输入后点击框外自动保存</li>
                            <li>点击表格任意行查看完整档案</li>
                        </ul>
                    </div>
                `;

                document.getElementById('studentListArea').innerHTML = html;

                document.getElementById('exportButton').classList.remove('hidden');

            } catch (err) {
                alert("加载数据失败：" + err.message);
            }
        }


        /***************************************************
         * Cloudflare Worker 版：删除学生
         ***************************************************/
        async function deleteStudent(id) {
            if (!confirm("确定删除该学生？")) return;

            try {
                await database.set("students/" + id, null);
                alert("已删除");
                loadStudents(); // 刷新
            } catch (err) {
                alert("删除失败：" + err.message);
            }
        }


        /***************************************************
         * Cloudflare Worker 版：更新最近联系时间
         ***************************************************/
        async function updateLastContact(id, value) {
            try {
                await database.set("students/" + id + "/lastContact", value);
            } catch (err) {
                alert("更新失败：" + err.message);
            }
        }


        /***************************************************
         * Cloudflare Worker 版：更新状态
         ***************************************************/
        async function updateStatus(id, val) {
            try {
                await database.set("students/" + id + "/status", val);
                showToast('状态已保存');
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        /***************************************************
         * Cloudflare Worker 版：更新评价
         ***************************************************/
        async function updateEval(id, val) {
            try {
                await database.set("students/" + id + "/evaluation", val);
                showToast('评价已保存');
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        /***************************************************
         * Cloudflare Worker 版：更新推荐学校
         ***************************************************/
        async function updateSchool(id, val) {
            try {
                await database.set("students/" + id + "/recommendSchool", val);
                showToast('推荐学校已保存');
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        /***************************************************
         * 提示弹窗（无需修改）
         ***************************************************/
        function showToast(message) {
            var toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText =
                    'position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px 20px; border-radius: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; opacity: 0; transition: opacity 0.3s;';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(function() {
                toast.style.opacity = '0';
            }, 2000);
        }

        async function exportToCSV() {
            try {
                // 通过 Worker 获取所有学生
                const data = await database.get("students");

                const students = [];
                if (data) {
                    for (const id in data) {
                        students.push(data[id]);
                    }
                }

                var csv = '\ufeff' +
                    '姓名,生日,邮箱,电话,学历,专业,毕业院校,项目类型,推荐人,推荐费,总费用,' +
                    '目标,能否自己申请,付费能力,推荐项目,技能,获奖经历,课外活动,' +
                    '文书完成,英语达标,对接人,签约,' +
                    '实习经历,项目经历,材料_PS,材料_CV,提交时间\n';

                for (var i = 0; i < students.length; i++) {
                    var s = students[i];
                    var time = s.submitTime ? new Date(s.submitTime).toLocaleString('zh-CN') : '';

                    // experience
                    var expStr = '';
                    if (s.experience && Array.isArray(s.experience)) {
                        expStr = s.experience.map(e =>
                            `${e.title || ''} (${e.time || ''}) - ${e.company || ''}: ${e.description || ''}`
                        ).join(' | ');
                    }

                    // projects
                    var projectStr = '';
                    if (s.projects && Array.isArray(s.projects)) {
                        projectStr = s.projects.map(p =>
                            `${p.title || ''} (${p.time || ''}) - ${p.description || ''}`
                        ).join(' | ');
                    }

                    csv +=
                        (s.name || '') + ',' +
                        (s.birthday || '') + ',' +
                        (s.email || '') + ',' +
                        (s.phone || '') + ',' +
                        (s.education || '') + ',' +
                        (s.major || '') + ',' +
                        (s.university || '') + ',' +
                        (s.program || '') + ',' +
                        (s.agent || '') + ',' +
                        (s.fee_agent || '') + ',' +
                        (s.fee_total || '') + ',' +

                        '"' + (s.goal || '').replace(/"/g, '""') + '",' +
                        (s.can_apply || '') + ',' +
                        (s.afford || '') + ',' +
                        '"' + (s.recommend_program || '').replace(/"/g, '""') + '",' +

                        '"' + (s.skills || '').replace(/"/g, '""') + '",' +
                        '"' + (s.awards || '').replace(/"/g, '""') + '",' +
                        '"' + (s.activities || '').replace(/"/g, '""') + '",' +

                        (s.ps_ready ? '是' : '否') + ',' +
                        (s.english_ok ? '是' : '否') + ',' +

                        (s.handler || '') + ',' +
                        (s.signed || '') + ',' +

                        '"' + expStr.replace(/"/g, '""') + '",' +
                        '"' + projectStr.replace(/"/g, '""') + '",' +

                        '"' + (s.ps_file || '') + '",' +
                        '"' + (s.cv_file || '') + '",' +
                        '"' + time + '"' +

                        '\n';
                }

                var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'students_' + new Date().toLocaleDateString() + '.csv';
                link.click();

                alert('导出成功');

            } catch (error) {
                alert("导出失败：" + error.message);
            }
        }

        renderTable();
        renderLogos();

        window.onclick = function(e) {
            if (e.target.id === 'programModal') {
                closeProgramModal();
            }
            if (e.target.id === 'loginModal') {
                closeLoginModal();
            }
            if (e.target.id === 'editProgramModal') {
                closeEditProgramModal();
            }
            if (e.target.id === 'editLogoModal') {
                closeEditLogoModal();
            }
        }

        window.addEventListener('load', async function () {
            console.log('🚀 页面加载完成，开始从 Firebase 获取合作院校和企业数据...');

            try {
                // 读取合作院校数据
                const partners = await database.get("partnerLogos");
                if (partners) {
                    partnerLogos = partners;
                    console.log("✅ 已加载合作院校数据:", partnerLogos);
                } else {
                    console.log("ℹ️ Firebase中暂无合作院校数据，使用默认空数组");
                    partnerLogos = [];
                }
                renderLogos();
            } catch (e) {
                console.error("❌ 加载合作院校数据失败:", e);
            }

            try {
                // 读取合作企业数据
                const companies = await database.get("companyLogos");
                if (companies) {
                    companyLogos = companies;
                    console.log("✅ 已加载企业数据:", companyLogos);
                } else {
                    console.log("ℹ️ Firebase中暂无企业数据，使用默认空数组");
                    companyLogos = [];
                }
                renderLogos();
            } catch (e) {
                console.error("❌ 加载企业数据失败:", e);
            }
        });

   // 打开详情弹窗
    function openPartnerDetail(type, index) {
        const data = (type === "partner" ? partnerLogos[index] : companyLogos[index]);

        document.getElementById("detailTitle").textContent =
            (type === "partner" ? "合作院校 - " : "合作企业 - ") + data.name;

        document.getElementById("detailIntro").value = data.intro || "";
        document.getElementById("detailMajor").value = data.major || "";
        document.getElementById("detailRequirement").value = data.requirement || "";

        // 不是管理员 -> 禁用输入框
        if (!currentUser || currentUser.role !== "admin") {
            document.getElementById("detailIntro").readOnly = true;
            document.getElementById("detailMajor").readOnly = true;
            document.getElementById("detailRequirement").readOnly = true;
            document.getElementById("detailSaveBtn").style.display = "none";
        } else {
            document.getElementById("detailIntro").readOnly = false;
            document.getElementById("detailMajor").readOnly = false;
            document.getElementById("detailRequirement").readOnly = false;
            document.getElementById("detailSaveBtn").style.display = "block";
        }

        // 显示弹窗
        document.getElementById("partnerDetailModal").style.display = "flex";

        // 保存当前正在编辑的项
        window.editingDetail = { type, index };
    }


    function closePartnerDetail() {
        document.getElementById("partnerDetailModal").style.display = "none";
    }


    // 保存详情（管理员）
    async function savePartnerDetail() {
        const { type, index } = window.editingDetail;

        const intro = document.getElementById("detailIntro").value.trim();
        const major = document.getElementById("detailMajor").value.trim();
        const requirement = document.getElementById("detailRequirement").value.trim();

        // 本地更新
        const targetList = (type === "partner" ? partnerLogos : companyLogos);

        targetList[index].intro = intro;
        targetList[index].major = major;
        targetList[index].requirement = requirement;

        const dbPath = type === "partner" ? "partnerLogos" : "companyLogos";

        try {
            // 写入 Worker → Firebase
            await database.set(dbPath, targetList);

            showToast("已保存");
            closePartnerDetail();

            // 重新渲染
            renderLogos();

        } catch (err) {
            alert("保存失败：" + err.message);
        }
    }

    // === 加载合作院校详情 ===
    database.get("partnerDetails")
        .then(data => partnerDetails = data || [])
        .catch(() => partnerDetails = []);


    // === 加载合作企业详情 ===
    database.get("companyDetails")
        .then(data => companyDetails = data || [])
        .catch(() => companyDetails = []);


    // 打开学生详情
    function openStudentDetail(id, data) {

        // 保存当前正在编辑的学生 ID
        window.currentEditingStudent = id;

        // 显示详情弹窗
        document.getElementById("studentDetailModal").style.display = "block";

        // 如果外部传入 data（例如刚提交表单的场景），直接使用
        if (data) {
            fillStudentDetailUI(data);
            return;
        }

        // 否则从 Firebase（通过 Cloudflare Worker 代理）加载
        database.get(`students/${id}`)
            .then(studentData => {
                fillStudentDetailUI(studentData || {});
            })
            .catch(err => {
                console.error("读取学生详情失败：", err);
                alert("读取学生详情失败");
            });
    }


    function fillStudentDetailUI(data) {
        document.getElementById("studentDetailTitle").innerText = data.name || "学生详情";

        // 基本信息
        document.getElementById("stu_name").value = data.name || "";
        document.getElementById("stu_birthday").value = data.birthday || "";
        document.getElementById("stu_email").value = data.email || "";
        document.getElementById("stu_phone").value = data.phone || "";
        document.getElementById("stu_education").value = data.education || "";
        document.getElementById("stu_program").value = data.program || "";
        document.getElementById("stu_major").value = data.major || "";
        document.getElementById("stu_university").value = data.university || "";

        // 推荐与费用
        document.getElementById("stu_agent").value = data.agent || "";
        document.getElementById("stu_fee_agent").value = data.fee_agent || "";
        document.getElementById("stu_fee_total").value = data.fee_total || "";

        // 学生情况
        document.getElementById("stu_goal").value = data.goal || "";
        document.getElementById("stu_can_apply").value = data.can_apply || "no";
        document.getElementById("stu_afford").value = data.afford || "medium";
        document.getElementById("stu_recommend_program").value = data.recommend_program || "";

        // 申请准备
        document.getElementById("stu_ps_ready").checked = !!data.ps_ready;
        document.getElementById("stu_english_ok").checked = !!data.english_ok;

        // 技能/奖项/活动
        document.getElementById("stu_skills").value = data.skills || "";
        document.getElementById("stu_awards").value = data.awards || "";
        document.getElementById("stu_activities").value = data.activities || "";

        // 对接人/签约
        document.getElementById("stu_handler").value = data.handler || "";
        document.getElementById("stu_signed").value = data.signed || "no";

        // 渲染数组类型
        renderExperience(data.experience || []);
        renderProjects(data.projects || []);

        // 渲染学校多选（若你有学校数组）
        try {
            renderSchoolSelection(data.schoolList || []);
        } catch (e) { /* ignore if not present */ }
    }


    async function saveStudentDetail() {
        const id = window.currentEditingStudent;

        const updatedData = {
            name: stu_name.value,
            birthday: stu_birthday.value,
            email: stu_email.value,
            phone: stu_phone.value,
            education: stu_education.value,
            program: stu_program.value,
            major: stu_major.value,
            university: stu_university.value,

            agent: stu_agent.value,
            fee_agent: stu_fee_agent.value,
            fee_total: stu_fee_total.value,

            goal: stu_goal.value,
            can_apply: stu_can_apply.value,
            afford: stu_afford.value,
            recommend_program: stu_recommend_program.value,

            ps_ready: stu_ps_ready.checked,
            english_ok: stu_english_ok.checked,

            handler: stu_handler.value,
            signed: stu_signed.value,

            schoolList: getSelectedSchools()
        };

        try {
            // 读取旧数据（避免覆盖其他字段，如 experience / projects / files 等）
            const oldData = await database.get(`students/${id}`) || {};

            // 合并
            const finalData = { ...oldData, ...updatedData };

            // 写入
            await database.set(`students/${id}`, finalData);

            alert("已保存！");
            closeStudentDetail();

        } catch (err) {
            console.error(err);
            alert("保存失败：" + err.message);
        }
    }

    function closeStudentDetail() {
        document.getElementById("studentDetailModal").style.display = "none";
    }

    function renderSchoolSelection(selectedList) {
        let html = "";
        schoolNames.forEach(school => {
            const checked = selectedList.includes(school) ? "checked" : "";
            html += `
                <label style="display:block;margin-bottom:6px;">
                    <input type="checkbox" value="${school}" class="schoolCheck" ${checked}>
                    ${school}
                </label>
            `;
        });
        document.getElementById("stu_school_list").innerHTML = html;
    }

    function getSelectedSchools() {
        const boxes = document.querySelectorAll(".schoolCheck:checked");
        const list = [];

        boxes.forEach(box => list.push(box.value));

        return list;
    }

    function showFileUpload() {
        const card = document.getElementById("fileUploadCard");
        if (card) {
            card.classList.remove("hidden");
            window.scrollTo({ top: 0, behavior: "smooth" });
        }
    }

    function hideFileUpload() {
        const card = document.getElementById("fileUploadCard");
        if (card) {
            card.classList.add("hidden");
        }
    }

    // 上传简历
    async function uploadResume() {
        const fileInput = document.getElementById("resumeFile");
        const file = fileInput.files[0];
        
        if (!file) {
            alert("请选择一个简历文件（PDF 或 DOCX）");
            return;
        }

        if (!file.type.match(/(pdf|vnd.openxmlformats-officedocument.wordprocessingml.document)/)) {
            alert("仅支持 PDF 或 DOCX 格式！");
            return;
        }

        let text = "";
        try {
            if (file.type === "application/pdf") {
            // 使用 PDF.js 提取文本
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";
            const maxPages = Math.min(pdf.numPages, 10); // 防止太长
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(" ") + "\n";
            }
            text = fullText;
            } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
            // 使用 Mammoth 提取 DOCX 文本
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            text = result.value;
            } else {
            throw new Error("不支持的文件类型");
            }
        } catch (err) {
            console.error("文件解析失败:", err);
            alert("简历文件解析失败，请确保格式正确。");
            return;
        }

        if (!text.trim()) {
            alert("未能从文件中提取到文本内容。");
            return;
        }

        // ✅ 关键：现在只传纯文本给 Worker！
        const requestPayload = {
            contents: [{
            parts: [{ text: text }]
            }]
        };

        alert("正在分析您的简历，请稍候…");

        try {
            const response = await fetch("https://tembusu.zhouqingyu27.workers.dev/gemini", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestPayload)
            });

            if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`分析失败 (${response.status}): ${errorText}`);
            }

            const result = await response.json();
            let output = result?.candidates?.[0]?.content?.parts?.[0]?.text || "";

            // 清理可能的 ```json 包裹
            output = output
            .trim()
            .replace(/^```json\s*/i, "")
            .replace(/\s*```$/, "");

            const parsedInfo = JSON.parse(output);

            const cleaned = {
            name: parsedInfo.name || "",
            birthday: parsedInfo.birthday || "",
            email: parsedInfo.email || "",
            phone: parsedInfo.phone || "",
            education: parsedInfo.education || "",
            program: parsedInfo.program || "",
            major: parsedInfo.major || "",
            university: parsedInfo.university || "",
            agent: parsedInfo.agent || "",
            fee_agent: parsedInfo.fee_agent || "",
            fee_total: parsedInfo.fee_total || "",
            goal: parsedInfo.goal || "",
            can_apply: parsedInfo.can_apply || "no",
            afford: parsedInfo.afford || "medium",
            recommend_program: parsedInfo.recommend_program || "",
            skills: parsedInfo.skills || "",
            awards: parsedInfo.awards || "",
            activities: parsedInfo.activities || "",
            experience: parsedInfo.experience || [],
            projects: parsedInfo.projects || []
            };

            const newId = safeUUID();
            await database.set(`students/${newId}`, cleaned);
            openStudentDetail(newId, cleaned);

            alert("简历分析成功并已保存！");
            fileInput.value = ""; // 清空文件选择

        } catch (error) {
            console.error("❌ 分析失败:", error);
            alert("分析失败：" + (error.message || "请检查控制台"));
        }
        }


   // =============================================
    // 基于 Cloudflare Worker 的 Gemini 简历分析函数
    // =============================================
    async function analyzeResumeWithGemini(file) {
        const base64 = await fileToBase64(file);

        const requestPayload = {
            contents: [
                {
                    parts: [
                        {
                            text: `
    你是专业的简历分析 AI。请从下面的简历文本中提取所有与个人信息、教育、经历、技能有关的内容。
    注意：
    1. 姓名可能不会带标签（如“姓名：”），请智能识别第一个出现的人名。
    2. 实习、项目、科研、课外活动都要尽可能总结。

    输出必须是严格 JSON，字段缺失请使用空字符串 ""：
    {
    "name": "",
    "birthday": "",
    "email": "",
    "phone": "",
    "education": "",
    "program": "",
    "major": "",
    "university": "",

    "agent": "",
    "fee_agent": "",
    "fee_total": "",

    "goal": "",
    "can_apply": "yes|no",
    "afford": "high|medium|low",
    "recommend_program": "",

    "skills": "",
    "awards": "",
    "activities": "",

    "experience": [
        { "title": "", "company": "", "time": "", "description": "" }
    ],

    "projects": [
        { "title": "", "time": "", "description": "" }
    ]
    }

    所有字段必须存在，缺失内容填空字符串 ""。
    数组为空则返回 []。
    请只输出 JSON，不要附带说明。
                            `.trim()
                        },
                        {
                            inlineData: {
                                mimeType: file.type,
                                data: base64
                            }
                        }
                    ]
                }
            ]
        };

        // 调用你的 Cloudflare Worker 代理
        const response = await fetch(
            "https://tembusu.zhouqingyu27.workers.dev/gemini",
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestPayload)
            }
        );

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Cloudflare Worker 返回错误：", errorText);
            throw new Error(`Gemini 请求失败: ${response.status}`);
        }

        const result = await response.json();

        // Worker 输出格式：data.candidates[0].content.parts[0].text
        let output = result?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!output) {
            console.error("Gemini 返回空内容：", result);
            throw new Error("Gemini 返回空内容");
        }

        // 去掉 ```json 包裹
        output = output
            .trim()
            .replace(/^```json/i, "")
            .replace(/```$/, "")
            .trim();

        // 安全解析
        try {
            return JSON.parse(output);
        } catch (e) {
            console.warn("Gemini 输出不是合法 JSON，返回原始文本：", output);
            return { resumeRawText: output };
        }
    }


    // =============================
    // 工具：文件 → Base64
    // =============================
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result.split(",")[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }


    // =============================
    // 从文本中提取字段（不修改功能）
    // =============================
    function extractResumeFields(text) {
        try {
            const json = JSON.parse(text);
            return {
                name: json.name || "",
                email: json.email || "",
                phone: json.phone || "",
                education: json.education || "",
                program: json.major || "",
                academic: json.skills || "",
                resumeRawText: text
            };
        } catch (e) {
            console.warn("Gemini 未返回 JSON，已存储原始文本");
            return { resumeRawText: text };
        }
    }


    function parseGeminiJson(text) {
        if (!text) return {};

        // 去掉 ```json ``` 包裹
        text = text.trim();
        if (text.startsWith("```")) {
            const firstLineEnd = text.indexOf("\n");
            const lastLineStart = text.lastIndexOf("```");
            if (lastLineStart > firstLineEnd) {
                text = text.substring(firstLineEnd, lastLineStart).trim();
            }
        }

        try {
            return JSON.parse(text);
        } catch (e) {
            console.warn("Gemini 返回非 JSON 内容，存储原始文本");
            return { resumeRawText: text };
        }
    }

    function renderExperience(list) {
        const area = document.getElementById("stu_experience_area");
        if (!area) return;
        if (!list || list.length === 0) {
            area.innerHTML = "<p style='color:#777;'>（暂无实习 / 工作经历）</p>";
            return;
        }

        area.innerHTML = list.map(exp => `
            <div class="exp-item" style="border: 1px solid #eee; padding:10px; border-radius:6px; margin-bottom:8px; background:#fafafa;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong style="font-size:14px;">${escapeHtml(exp.title || exp.position || "")}</strong>
                    <span style="font-size:12px;color:#666;">${escapeHtml(exp.time || "")}</span>
                </div>
                <div style="font-size:13px;color:#555;margin-top:6px;">
                    <em>${escapeHtml(exp.company || "")}</em>
                    <p style="margin:6px 0 0 0;">${escapeHtml(exp.description || "")}</p>
                </div>
            </div>
        `).join("");
    }

    function renderProjects(list) {
        const area = document.getElementById("stu_projects_area");
        if (!area) return;
        if (!list || list.length === 0) {
            area.innerHTML = "<p style='color:#777;'>（暂无项目经历）</p>";
            return;
        }

        area.innerHTML = list.map(p => `
            <div class="proj-item" style="border: 1px solid #eee; padding:10px; border-radius:6px; margin-bottom:8px; background:#fff;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <strong style="font-size:14px;">${escapeHtml(p.title || p.name || "")}</strong>
                    <span style="font-size:12px;color:#666;">${escapeHtml(p.time || "")}</span>
                </div>
                <p style="margin:8px 0 0 0;color:#444;">${escapeHtml(p.description || "")}</p>
            </div>
        `).join("");
    }

    // 简单 HTML 转义（防注入）
    function escapeHtml(s) {
        if (!s) return "";
        return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }


    </script>
</body>
</html>